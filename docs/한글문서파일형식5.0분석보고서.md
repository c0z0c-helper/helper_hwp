## 한글 문서 파일 형식 5.0 개발 문서 (HWP 5.0 Technical Specification)

본 문서는 `한글 워드 프로세서 파일 형식 5.0`을 기반으로 작성되었습니다. 해당 형식은 2000년 10월 이후 출시된 한글 제품군(워디안, 2002, 2005, 2007, 2010, 2014, 2018 등)에서 사용되며, 파일 크기를 최소화하기 위해 압축 기능을 사용합니다.

HWP 5.0 파일은 **윈도우즈의 복합 파일(Compound File)에 기초**를 둔 구조이며, 내부적으로 스토리지(Storage)와 스트림(Stream)으로 구분됩니다. 문자 코드는 **유니코드(UTF-16LE) 형식**을 기반으로 합니다. 모든 두 바이트 이상의 자료형은 **리틀 엔디언(Little-endian)** 형태입니다.

### 1. 자료형 설명

문서 파일에 저장되는 정보는 아래 표에 설명된 자료형을 이용해 표현됩니다.

| 자료형 (Type) | 길이(바이트) | 부호 | 설명 |
| :--- | :--- | :--- | :--- |
| **BYTE** | 1 | | 부호 없는 한 바이트 (0~255) |
| **WORD** | 2 | | 16비트 컴파일러에서 ‘unsigned int’에 해당 |
| **DWORD** | 4 | | 16비트 컴파일러에서 ‘unsigned long’에 해당 |
| **WCHAR** | 2 | | 한글의 기본 코드로 유니코드 기반 문자 |
| **HWPUNIT** | 4 | | 1/7200인치로 표현된 한글 내부 단위. (예: 2인치는 14400) |
| **SHWPUNIT** | 4 | √ | 1/7200인치로 표현된 한글 내부 단위 |
| **UINT8** | 1 | | ‘unsigned \_\_int8’에 해당 |
| **UINT16** | 2 | | ‘unsigned \_\_int16’에 해당 |
| **UINT32(=UINT)**| 4 | | ‘unsigned \_\_int32’에 해당 |
| **INT8** | 1 | √ | ‘signed \_\_int8’에 해당 |
| **INT16** | 2 | √ | ‘signed \_\_int16’에 해당 |
| **INT32** | 4 | √ | ‘signed \_\_int32’에 해당 |
| **HWPUNIT16** | 2 | √ | INT16과 같다. |
| **COLORREF** | 4 | | RGB값(0x00bbggrr)을 십진수로 표시. |
| **BYTE stream** | 가변 | | 일련의 BYTE로 구성됨. |

### 2. 파일 포맷 트리 구조 (Storage & Stream)

HWP 5.0 파일은 복합 파일(Compound File) 구조를 가지며, 내부 구조는 다음과 같습니다:

| Storage 이름 (스토리지) | Stream 이름 (스트림) | 저장 정보 | 압축/암호화 여부 |
| :--- | :--- | :--- | :--- |
| (Root) | **FileHeader** | 파일 인식 정보 | × |
| (Root) | **DocInfo** | 문서 정보 (글꼴, 스타일 등 세부 정보) | √ |
| **BodyText** | **Section0, Section1, ...** | 본문 내용 (문단, 표, 개체 등) | √ |
| (Root) | **\005HwpSummaryInformation** | 문서 요약 | × |
| **BinData** | **BinaryData0, BinaryData1, ...** | 바이너리 데이터 (그림, OLE 등) | √ |
| (Root) | **PrvText** | 미리보기 텍스트 | × |
| (Root) | **PrvImage** | 미리보기 이미지 (BMP 또는 GIF 형식) | × |
| **DocOptions** | **\_LinkDoc, DrmLicense, ...** | 문서 옵션 (연결 문서, DRM, 전자 서명 등) | × |
| **Scripts** | **DefaultJScript, JScriptVersion, ...** | 스크립트 코드 | × |
| **XMLTemplate** | **Schema, Instance, ...** | XML 템플릿 정보 | × |
| **DocHistory** | **VersionLog0, VersionLog1, ...** | 문서 이력 관리 정보 | √ |
| **Bibliography** | (Stream) | 참고문헌 정보 (.XML 파일 형태) | × |

### 3. 주요 데이터 레코드 구조 및 필드 상세

HWP 5.0 파일의 데이터는 **데이터 레코드** 구조를 가지며, 이는 헤더(32비트)와 데이터로 구성됩니다. 헤더는 `Tag ID` (10bits), `Level` (10bits), `Size` (12bits)로 구성되어 있습니다. Size가 4095 바이트 이상일 경우 레코드 헤더에 이어 길이를 나타내는 `DWORD`가 추가됩니다.

#### 3.1. 파일 인식 정보 (`FileHeader` Stream)

파일의 가장 첫 부분에 위치하며, HWP 문서임을 나타내고 기본적인 버전을 포함합니다. 전체 길이는 256 바이트입니다.

| 오프셋 | 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- | :--- |
| 0 | BYTE array | 32 | **signature**: "HWP Document File" |
| 32 | DWORD | 4 | **파일 버전**: 0xMMnnPPrr 형태 (예: 5.0.3.0) |
| 36 | DWORD | 4 | **속성 (Bit Flags)**: 압축 여부 (bit 0), 암호 설정 여부 (bit 1), 배포용 문서 여부 (bit 2) 등 |
| 40 | DWORD | 4 | **속성 (CCL/복제)**: CCL 라이선스 정보 (bit 0), 복제 제한 여부 (bit 1) 등 |
| 44 | DWORD | 4 | **EncryptVersion**: 글 2.5 이하 (1), 글 3.0 Enhanced (2), 글 7.0 이후 (4) 등 |
| 48 | BYTE | 1 | **KOGL 라이선스 지원 국가**: 6(KOR), 15(US) |
| 49 | BYTE array | 207 | 예약 |
| (전체) | | 256 | |

#### 3.2. 문서 정보 레코드 (`DocInfo` Stream)

`DocInfo` 스트림은 문서 내 공통으로 사용되는 글꼴, 스타일, 문단 모양 등에 대한 세부 정보를 담고 있으며, 여러 HWPTAG 레코드로 구성됩니다.

##### 3.2.1. 문서 속성 (`HWPTAG_DOCUMENT_PROPERTIES`, Tag ID: 0x010)

문서의 기본적인 시작 번호와 캐럿 위치를 정의합니다.

| 자료형 | 길이 (바이트) | 설명 |
| :--- | :--- | :--- |
| UINT16 | 2 | **구역 개수** |
| UINT16 | 2 | **페이지 시작 번호** |
| UINT16 | 2 | **각주 시작 번호** |
| UINT16 | 2 | **미주 시작 번호** |
| UINT16 | 2 | **그림 시작 번호** |
| UINT16 | 2 | **표 시작 번호** |
| UINT16 | 2 | **수식 시작 번호** |
| UINT32 | 4 | **리스트 아이디** (캐럿 위치) |
| UINT32 | 4 | **문단 아이디** (캐럿 위치) |
| UINT32 | 4 | **문단 내 글자 단위 위치** (캐럿 위치) |
| (전체) | 26 | |

##### 3.2.2. 아이디 매핑 헤더 (`HWPTAG_ID_MAPPINGS`, Tag ID: 0x011)

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| INT32 array[18] | 72 | **아이디 매핑 개수** (18개 항목)<br>- 0: 바이너리 데이터<br>- 1~7: 한글, 영어, 한자, 일어, 기타, 기호, 사용자 글꼴<br>- 8: 테두리/배경<br>- 9: 글자 모양<br>- 10: 탭 정의<br>- 11: 문단 번호<br>- 12: 글머리표<br>- 13: 문단 모양<br>- 14: 스타일<br>- 15~17: 기타 매핑 |
| (전체) | 72 | Doc Version에 따라 가변적 |

##### 3.2.3. 글자 모양 (`HWPTAG_CHAR_SHAPE`, Tag ID: 0x014)

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| WORD array[7] | 14 | **언어별 글꼴 ID** (FaceID) 참조 값 (한글, 영어, 한자, 일어, 기타, 기호, 사용자) |
| UINT8 array[7] | 7 | **언어별 장평** (50%～200%) |
| INT8 array[7] | 7 | **언어별 자간** (-50%～50%) |
| UINT8 array[7] | 7 | **언어별 상대 크기** (10%～250%) |
| INT8 array[7] | 7 | **언어별 글자 위치** (-100%～100%) |
| INT32 | 4 | **기준 크기** (0pt～4096pt) |
| UINT32 | 4 | **속성** (기울임, 진하게, 밑줄 종류/모양, 외곽선, 그림자 종류 등 Bit Flags) |
| INT8 | 1 | **그림자 간격 X** (-100%～100%) |
| INT8 | 1 | **그림자 간격 Y** (-100%～100%) |
| COLORREF | 4 | **글자 색** |
| COLORREF | 4 | **밑줄 색** |
| COLORREF | 4 | **음영 색** |
| COLORREF | 4 | **그림자 색** |
| UINT16 | 2 | **글자 테두리/배경 ID** (CharShapeBorderFill ID) 참조 값 (5.0.2.1 이상) |
| COLORREF | 4 | **취소선 색** (5.0.3.0 이상) |
| (전체) | 72 | |

#### 3.3. 본문 레코드 (`BodyText/Section%d` Stream)

본문 스트림은 문단(Paragraph)의 연속으로 구성되며, 각 문단은 여러 HWPTAG 레코드로 구성됩니다.

##### 3.3.1. 문단 헤더 (`HWPTAG_PARA_HEADER`, Tag ID: 0x040)

모든 문단의 시작을 알리는 필수 레코드입니다.

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| UINT32 | 4 | **텍스트 문자 수** (nchars)<br>※ 최상위 비트(0x80000000)가 켜져 있으면 `nchars &= 0x7FFFFFFF` 처리 |
| UINT32 | 4 | **컨트롤 마스크** (문단에 포함된 컨트롤 종류 Bit Flags)<br>※ `(UINT32)(1<<ctrlch)` 조합 |
| UINT16 | 2 | **문단 모양 아이디** 참조값 |
| UINT8 | 1 | **문단 스타일 아이디** 참조값 |
| UINT8 | 1 | **단 나누기 종류**<br>- 0x01: 구역 나누기<br>- 0x02: 다단 나누기<br>- 0x04: 쪽 나누기<br>- 0x08: 단 나누기 |
| UINT16 | 2 | **글자 모양 정보 수** (문단 내 글자 모양이 바뀌는 횟수) |
| UINT16 | 2 | **Range Tag 정보 수** (형광펜, 교정 부호 등) |
| UINT16 | 2 | **Align 정보 수** (각 줄에 대한 align 정보 수) |
| UINT32 | 4 | **문단 Instance ID** (문서 내 고유 ID) |
| UINT16 | 2 | **변경추적 병합 문단 여부** (5.0.3.2 이상) |
| (전체) | 24 | |

##### 3.3.2. 문단의 텍스트 (`HWPTAG_PARA_TEXT`, Tag ID: 0x041)

문단 헤더의 `텍스트 문자 수 (nchars)`만큼의 유니코드 텍스트 데이터가 저장됩니다.

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| WCHAR array[nchars] | 2 × nchars | **문자 수만큼의 텍스트** |

##### 3.3.3. 문단의 글자 모양 (`HWPTAG_PARA_CHAR_SHAPE`, Tag ID: 0x042)

문단 내에서 글자 모양이 변경되는 지점의 정보가 저장됩니다.

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| UINT32 | 4 | **글자 모양이 바뀌는 시작 위치** |
| UINT32 | 4 | **글자 모양 ID** |
| (반복) | 8 × n | n: 문단 헤더의 '글자 모양 정보 수' |

##### 3.3.4. 문단의 레이아웃 (`HWPTAG_PARA_LINE_SEG`, Tag ID: 0x043)

문단의 각 줄을 출력할 때 사용되는 캐시 정보입니다. 문단 정보의 '각 줄에 대한 align에 대한 정보 수'만큼 반복됩니다.

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| UINT32 | 4 | **텍스트 시작 위치** |
| INT32 | 4 | **줄의 세로 위치** |
| INT32 | 4 | **줄의 높이** |
| INT32 | 4 | **텍스트 부분의 높이** |
| INT32 | 4 | **줄의 세로 위치에서 베이스라인까지 거리** |
| INT32 | 4 | **줄간격** |
| INT32 | 4 | **컬럼에서의 시작 위치** |
| INT32 | 4 | **세그먼트의 폭** |
| UINT32 | 4 | **태그** (속성 비트 플래그)<br>- bit 0: 페이지의 첫 줄<br>- bit 1: 컬럼의 첫 줄<br>- bit 16: 텍스트가 배열되지 않은 빈 세그먼트<br>- bit 17: 줄의 첫 세그먼트<br>- bit 18: 줄의 마지막 세그먼트<br>- bit 19: auto-hyphenation 수행 여부<br>- bit 20: indentation 적용<br>- bit 21: 문단 머리 모양 적용<br>- bit 31: 구현상의 편의를 위한 property |
| (전체) | 36 | |

##### 3.3.5. 문단의 영역 태그 (`HWPTAG_PARA_RANGE_TAG`, Tag ID: 0x044)

텍스트의 일정 영역을 마킹하는 용도로 사용되며 (예: 형광펜, 교정 부호), 글자 모양과는 달리 각 영역은 서로 겹칠 수 있습니다.

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| UINT32 | 4 | **영역 시작** |
| UINT32 | 4 | **영역 끝** |
| UINT32 | 4 | **태그** (상위 8비트는 종류, 하위 24비트는 임의의 데이터) |
| (반복) | 12 × n | n: 영역 태그 정보 수 |

#### 3.4. 컨트롤 레코드

##### 3.4.1. 컨트롤 헤더 (`HWPTAG_CTRL_HEADER`, Tag ID: 0x04B)

컨트롤 문자가 존재할 때 컨트롤 정보를 생성합니다.

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| UINT32 | 4 | **컨트롤 ID** (CtrlID) |
| (전체) | 4 | |

##### 3.4.2. 문단 리스트 헤더 (`HWPTAG_LIST_HEADER`, Tag ID: 0x04C)

표, 각주 등 문단 리스트를 포함하는 컨트롤에 대한 헤더 정보입니다.

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| INT16 | 2 | **문단 수** |
| UINT32 | 4 | **속성** (텍스트 방향, 줄바꿈 방식, 세로 정렬 등) |
| (전체) | 6 | |

##### 3.4.3. 컨트롤 임의의 데이터 (`HWPTAG_CTRL_DATA`, Tag ID: 0x04D)

컨트롤의 필드 이름이나 하이퍼링크 정보 등 임의의 데이터를 Parameter Set 형식으로 저장합니다.

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| BYTE stream | 가변 | **파라미터 셋** (HWPTAG_DOC_DATA에서 사용된 파라미터 셋 구조 참조) |
| (전체) | 가변 | |

##### 3.4.4. 개체 공통 속성 (`HWPTAG_SHAPE_COMPONENT` 등)

확장 컨트롤(extended type)의 상세 데이터입니다.

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| UINT32 | 4 | **컨트롤 ID** (Ctrl ID) |
| UINT32 | 4 | **속성** (글자처럼 취급 여부, 위치 기준, 텍스트 흐름 옵션 등) |
| HWPUNIT | 4 | **세로 오프셋 값** |
| HWPUNIT | 4 | **가로 오프셋 값** |
| HWPUNIT | 4 | **오브젝트의 폭** (width) |
| HWPUNIT | 4 | **오브젝트의 높이** (height) |
| INT32 | 4 | **z-order** |
| HWPUNIT16 array | 8 | **오브젝트의 바깥 4방향 여백** |
| UINT32 | 4 | **문서 내 각 개체에 대한 고유 아이디** (instance ID) |
| INT32 | 4 | **쪽나눔 방지** (1: on / 0: off) |
| WORD | 2 | **개체 설명문 글자 길이** (len) |
| WCHAR array[len] | 2×len | **개체 설명문 글자** |
| (전체) | 46 + (2×len) | |

> **참고**: 표 개체, 그리기 개체, 그림 개체, OLE 개체 등은 이 `개체 공통 속성` 이후에 해당 개체만의 추가 속성 레코드가 붙어 저장됩니다. 예를 들어, 표 개체는 `HWPTAG_TABLE`, 그림 개체는 `HWPTAG_SHAPE_COMPONENT_PICTURE` 등이 이어집니다.

##### 3.4.5. 개체 이외의 컨트롤 상세 구조

| 컨트롤 ID | 태그 ID | 구조 요약 | 출처 |
|:---|:---|:---|:---|
| 구역 정의 ('sec d') | HWPTAG\_CTRL\_HEADER | 속성(4) + 단 간격(2) + 줄맞춤(2×2) + 탭 간격(4) + 번호 모양 ID(2) + 쪽 번호(2) + 그림/표/수식 번호(2×3) + 대표 Language(2) + *하위 레코드(용지 설정, 각주/미주 모양, 쪽 테두리/배경 등)* (총 길이 140 바이트 포함) | |
| 머리말/꼬리말 ('head'/'foot') | HWPTAG\_LIST\_HEADER | 속성(4) + 텍스트 영역 폭(4) + 텍스트 영역 높이(4) + 텍스트/번호 참조 여부(1×2) + **문단 리스트** | |
| 자동 번호 ('atno') | HWPTAG\_CTRL\_HEADER | 속성(4) + 번호(2) + 사용자 기호(2) + 앞/뒤 장식 문자(2×2) (총 12 바이트) | |
| 새 번호 지정 ('nwno') | HWPTAG\_CTRL\_HEADER | 속성(4) + 번호(2) (총 8 바이트) | |
| 감추기 ('pghd') | HWPTAG\_CTRL\_HEADER | 속성(2) (총 2 바이트) | |
| 쪽 번호 위치 ('pgnp') | HWPTAG\_CTRL\_HEADER | 속성(4) + 사용자 기호(2) + 앞/뒤 장식 문자(2×2) + 항상 "-"(2) (총 12 바이트) | |
| 찾아보기 표식 ('idxm') | HWPTAG\_CTRL\_HEADER | 키워드 길이(2) + 키워드1(2×len1) + 키워드 길이(2) + 키워드2(2×len2) + dummy(2) (총 6 + 2×(len1+len2) 바이트) | |
| 글자 겹침 ('tcps') | HWPTAG\_CTRL\_HEADER | ctrl ID(4) + 겹칠 글자 길이(2) + 겹칠 글자(2×len) + 테두리 타입(1) + 내부 글자 크기(1) + 테두리 내부 글자 펼침(1) + 속성 ID 수(1) + charshapeid 배열(4×cnt) (총 10 + 2×len + 4×cnt 바이트) | |
| 덧말 ('tdut') | HWPTAG\_CTRL\_HEADER | Main Text 길이/내용(2 + 2) + Sub Text 길이/내용(2 + 2) + 덧말 위치(4) + Fsizeratio(4) + Option(4) + Style number(4) + 정렬 기준(4) (총 18 바이트) | |
| 숨은 설명 ('tcmt') | HWPTAG\_LIST\_HEADER | **문단 리스트**만을 포함 | |
| 필드 시작 | HWPTAG\_CTRL\_HEADER | ctrl ID(4) + 속성(4) + 기타 속성(1) + command 길이(2) + command(2×len) + id(4) (총 15 + 2×len 바이트) | |

#### 3.5. 문서 이력 관리 (`DocHistory` Storage)

문서 이력 관리는 "DocHistory" 스토리지 내부에 VersionLog%d 스트림으로 저장되며, 압축 및 암호화될 수 있습니다.

이력 아이템은 `HISTORY_RECORD_TYPE_STAG` (0x10) 레코드로 시작하여, `HISTORY_RECORD_TYPE_ETAG` (0x11) 레코드로 종료됩니다.

##### 3.5.1. 히스토리 아이템 정보 시작 (`HISTORY_RECORD_TYPE_STAG`)

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| WORD | 2 | **flag** (포함 레코드 플래그) |
| UINT | 4 | **option** (버전 정보 관련 공통 옵션, 예: HWPVERSION_AUTOSAVE) |
| (전체) | 6 | |

##### 3.5.2. 히스토리 아이템 정보 끝 (`HISTORY_RECORD_TYPE_ETAG`)

| 자료형 | 길이(바이트) | 설명 |
| :--- | :--- | :--- |
| NONE | 0 | 첨부 데이터 Type: NONE |
| (전체) | 0 | |

##### 3.5.3. 히스토리 상세 정보 레코드

| Tag ID | 자료형 | 설명 | 출처 |
|:---|:---|:---|:---|
| HISTORY\_RECORD\_TYPE\_VERSION (0x20) | DWORD | 히스토리 아이템 버전 | |
| HISTORY\_RECORD\_TYPE\_DATE (0x21) | SYSTEMDATE | 히스토리 날짜 | |
| HISTORY\_RECORD\_TYPE\_WRITER (0x22) | WCHAR | 히스토리 작성자 | |
| HISTORY\_RECORD\_TYPE\_DESCRIPTION (0x23) | WCHAR | 히스토리 설명 | |
| HISTORY\_RECORD\_TYPE\_DIFFDATA (0x30) | WCHAR | 비교 정보 (DiffML) | |
| HISTORY\_RECORD\_TYPE\_LASTDOCDATA (0x31) | WCHAR | 가장 마지막 최근 문서 (HWPML) | |

---

### 4. 마크다운 변환 프로그램 개발 시 고려 사항

HWP 5.0 형식은 복잡한 계층 구조를 가지고 있습니다. Python으로 변환 프로그램을 개발하실 때, 특히 다음 사항들을 고려하시면 좋습니다.

1.  **Compound File 처리:** OLE 복합 파일 구조를 읽는 라이브러리 (예: `olefile` 또는 관련 파이썬 라이브러리)를 사용하여 스토리지와 스트림에 접근해야 합니다.
2.  **레코드 처리:** `DocInfo`나 `BodyText` 스트림을 읽을 때, 레코드 헤더(Tag ID, Level, Size)를 정확히 파싱하여 다음 레코드를 건너뛸지, 내용을 처리할지 결정해야 합니다.
3.  **문단 구조:** 문단 헤더(`HWPTAG_PARA_HEADER`)를 먼저 읽어 텍스트 길이와 포함된 컨트롤 종류를 확인하는 것이 중요합니다.
4.  **컨트롤 처리:** 표(`HWPTAG_TABLE`), 그림(`HWPTAG_SHAPE_COMPONENT_PICTURE`), 수식(`HWPTAG_EQEDIT`) 등은 모두 **확장 컨트롤(extended control)** 형태로 존재하며, 각 컨트롤 헤더(`HWPTAG_CTRL_HEADER`) 다음에 해당 개체의 데이터 레코드가 이어지므로, 컨트롤 종류에 따라 데이터 구조를 다르게 파싱해야 합니다.
