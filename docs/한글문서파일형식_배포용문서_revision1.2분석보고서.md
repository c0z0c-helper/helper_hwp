# 한글 배포용 문서 파일 형식 개발 문서 (HWP Distribution Document Format)

본 문서는 한글 워드 프로세서 파일 저장 형식 중, 배포용 문서(Document for Distribution)의 핵심 데이터 구조 및 복호화 과정을 설명합니다.

## 1. 개요: 배포용 문서의 특징 및 암호화 대상

배포용 문서는 원본 문서의 일반적인 편집을 제한하기 위해 설계된 기능입니다. 일반 문서와 달리 복사/붙이기, 인쇄 제한 등의 설정을 포함하며, 파일의 특정 스트림을 암호화합니다.

### 1.1. 배포용 문서와 일반 문서의 차이점

| 구분 | 배포용 문서 | 일반 문서 | 비고 |
| :--- | :--- | :--- | :--- |
| 본문 스트림 | `ViewText/Section` | `BodyText/Section` | 복사, 인쇄 제한 플래그를 가짐 |
| 암호화 여부 | O | X | |

### 1.2. 암호화 대상 스트림 (파일 포맷의 트리 구조)

배포용 문서는 다음 스트림들을 암호화하며, 이 스트림들은 **`HWPTAG_DISTRIBUTE_DOC_DATA` 레코드**로 시작됩니다.

| 스토리지 | 스트림 이름 | 설명 |
| :--- | :--- | :--- |
| ViewText | Section0 ... N | 본문 스트림 (구역별) |
| Scripts | JScriptVersion | 스크립트 버전 |
| Scripts | DefaultJScript | 스크립트 헤더, 소스 등 |
| DocHistory | HistoryLastDoc | 문서 이력 관리의 최종 문서 |
| DocHistory | VersionLog0 ... N | 문서 이력 관리의 각 버전 로그 |

## 2. 배포용 문서 데이터 레코드 상세

암호화된 스트림의 시작은 `HWPTAG_DISTRIBUTE_DOC_DATA` (Tag ID: HWPTAG\_BEGIN+12) 레코드이며, 총 256바이트의 데이터 필드를 가집니다.

| 자료형 | 길이 (바이트) | 필드 설명 |
| :--- | :--- | :--- |
| `BYTE array` | 256 | 배포용 문서 데이터 |
| **전체 길이** | **256** | |

이 256바이트의 데이터에는 복호화에 필요한 Seed, 암호 해시코드, 옵션 플래그를 추출하기 위한 정보가 포함되어 있습니다.

### 2.1. 해시코드와 옵션 플래그 데이터 구조

난수 배열을 생성하고 `배포용 문서 데이터`와 XOR 병합한 후, 특정 오프셋에서 82바이트를 추출하면 다음과 같은 구조를 얻을 수 있습니다.

| 오프셋 (XOR 병합 후) | 자료형 | 길이 (바이트) | 포맷 | 설명 |
| :--- | :--- | :--- | :--- | :--- |
| 0 | `WCHAR array` | 80 | WCHAR (UTF-16LE) | 암호의 SHA1 해시코드. 암복호화 키(처음 16바이트)로 사용됨. |
| 80 | `WCHAR` | 2 | WCHAR (UTF-16LE) | 배포용 문서 옵션 플래그. |
| 80 | - | - | `0x01` | 복사 방지 설정 |
| 80 | - | - | `0x02` | 인쇄 방지 설정 |
| **전체 길이** | - | **82** | | |

## 3. 배포용 문서 복호화 과정

암호화된 스트림을 복호화하려면 아래 단계를 순차적으로 수행해야 합니다. 복호화된 데이터는 각 레코드별 설명에 따라 읽을 수 있습니다.

### 3.1. 1단계: Seed 찾기 (4 Bytes)

복호화 과정에 필요한 `Seed` 값은 **`배포용 문서 데이터`의 처음 4바이트**입니다.

| 자료형 | 길이 (바이트) | 포맷 | 설명 |
| :--- | :--- | :--- | :--- |
| `UINT` | 4 | 32비트 부호 없는 정수 | Seed 값. |

### 3.2. 2단계: 난수 배열 (Random Array) 생성 (256 Bytes)

해시코드를 추출하기 위해서는 특정 패턴을 지닌 256바이트의 난수 배열을 생성해야 합니다. 이 과정은 MS Visual C의 랜덤 함수(`srand()`, `rand()`)를 사용합니다.

1.  `srand()`를 찾은 **Seed**로 초기화합니다.
2.  `rand()` 함수를 반복 호출하여 256바이트 배열을 채웁니다.
    *   **홀수 번째 `rand()` 호출 결과:** `A = rand() & 0xFF` (배열에 채워질 값).
    *   **짝수 번째 `rand()` 호출 결과:** `B = (rand() & 0x0F) + 1` (배열에 채워질 횟수).
3.  값 `A`를 횟수 `B`만큼 배열에 삽입하는 과정을 배열 크기가 256이 될 때까지 반복합니다.

### 3.3. 3단계: 해시코드 및 옵션 플래그 추출 (82 Bytes)

1.  **Offset 계산:** 해시코드가 시작되는 위치(Offset)를 계산합니다.
    $$
    offset = (\text{Seed} \land 0\text{x}0\text{f}) + \text{sizeof(UINT)}
    $$
    *여기서 $\text{sizeof(UINT)}$는 4바이트입니다.*
2.  **XOR 병합:** 생성된 **난수 배열 (256 Bytes)**과 원본 **배포용 문서 데이터 (256 Bytes)**를 XOR 병합합니다.
3.  **추출:** XOR 병합된 결과값에서 계산된 `offset`만큼 떨어진 위치부터 **80바이트**가 SHA1 해시코드이며, 그 다음 **2바이트**가 옵션 플래그입니다.

### 3.4. 4단계: 레코드 복호화 (AES-128 ECB)

1.  **암호화 키:** 추출된 SHA1 해시코드의 **처음 16바이트**를 복호화 키로 사용합니다.
2.  **복호화 알고리즘:** 본문 레코드는 **AES-128 ECB**를 통해 암호화되었으므로, 동일한 알고리즘을 사용하여 복호화할 수 있습니다.

복호화된 데이터는 이제 각 레코드 설명(예: 한글 문서 파일 형식 5.0 명세)에 따라 읽고 Markdown 변환 프로그램에서 처리할 수 있습니다.
